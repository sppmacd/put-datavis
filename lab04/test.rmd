---
title: "Short Video Platform Analytics"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r global, include=FALSE, message=TRUE, warning=TRUE}
# Load necessary packages
library(dplyr)
library(flexdashboard)
library(ggplot2)
library(ggsci)
library(plotly)
library(readr)
library(scales)
library(shiny)
library(stringr)
library(tibble)

# Load dataset (setwd() to repo/lab04)
df <- read_csv("main_chinese_data.csv")
categories_cn_en <- read_csv("categories_cn_en.csv")

#####

# load the full dataset (setwd() to repo/lab04)
interaction_filtered <- read_csv("interaction_filtered_small.csv")

#####

# Define main city tiers for mapping
tiers_main <- c("first-tier city", "new first-tier city", "second-tier city", "third-tier city")
df$plot_tier <- ifelse(df$fre_city_level_en %in% tiers_main, df$fre_city_level_en, "other")

# Convert character engagement columns to logical (if needed) and sum up engagement
engage_cols <- c("click", "liked.", "follow", "collect", "forward")
df[engage_cols] <- lapply(df[engage_cols], function(x) as.logical(ifelse(x == "True", TRUE, FALSE)))
df$engagement <- rowSums(df[engage_cols], na.rm = TRUE)

# Function to get hourly engagement data
get_hourly_engagement <- function(hour) {
  hour <- as.numeric(hour)
  df %>%
    filter(p_hour == hour) %>%
    group_by(plot_tier) %>%
    summarise(
      total_engagement = sum(engagement, na.rm = TRUE),
      avg_engagement = mean(engagement, na.rm = TRUE),
      count = n(),
      .groups = 'drop'
    ) %>%
    arrange(desc(total_engagement))
}

# Function to get all hours data for time series
get_all_hours_data <- function() {
  df %>%
    group_by(p_hour, plot_tier) %>%
    summarise(
      total_engagement = sum(engagement, na.rm = TRUE),
      avg_engagement = mean(engagement, na.rm = TRUE),
      .groups = 'drop'
    )
}
```

Overview
========

Help, about, logo etc.

Dataset from the paper ["A Large-scale Dataset with Behavior, Attributes, and Content of Mobile Short-video Platform"](https://arxiv.org/pdf/2502.05922)
(https://github.com/tsinghua-fib-lab/ShortVideo_dataset)

Categories {data-orientation=rows}
==========

```{r }
category_data <- reactive(interaction_filtered %>%
    filter(category_id %in% input$categories) %>%
    # add category name from categories_cn_en
    inner_join(categories_cn_en, by = "category_id") %>%
    # use category_name_en as category_name
    mutate(category_name = category_name_en)
)

category_engagement = function() { category_data() %>%
  summarise(
    views = n(),
    clicks = sum(click, na.rm = TRUE),
    comments = sum(comment, na.rm = TRUE),
    follows = sum(follow, na.rm = TRUE),
    collects = sum(collect, na.rm = TRUE),
    forwards = sum(forward, na.rm = TRUE),
    hates = sum(hate, na.rm = TRUE),
    likes = sum(cvm_like, na.rm = TRUE),
    .groups = 'drop'
  )
}

ALPHA = 0.6

# generate a color map from category_name that we will use for every
# plot (we want a shared legend)
# (Use the default ggplot theme, because others won't get applied
# for some reasone)
category_colors <- reactive({
  if (nrow(category_data()) == 0) {
    return(NA)
  }
  gg_color_hue <- function(n) {
    hues = seq(15, 375, length = n + 1)
    hcl(h = hues, l = 65, c = 100)[1:n]
  }
  setNames(
    gg_color_hue(length(unique(category_data()$category_name))),
    unique(category_data()$category_name)
  )
})

# create a ggplot theme with category_colors()
# (Somehow make this reactive)

theme_category <- function() {
  return (labs(color=NULL, alpha=NULL, fill=NULL) +
    scale_alpha_continuous(range = c(ALPHA, ALPHA), guide="none")
  )
}

PLOTLY = function (plot) {
  # tooltip: don't show alpha, color, fill
  ggplotly(plot, tooltip = c("x", "y")) %>%
    hide_legend()
} 
```

Column {.sidebar data-width=250}
-----------------------------------------------------------------------

```{r results = "asis"}
# only lvl 1 categories
tv_data <- categories_cn_en %>%
  filter(category_level == 1) %>%
  # First letter always uppercase
  mutate(title = str_to_title(category_name_en)) %>%
  arrange(category_name_en)

# create c(title = category_id)
logger::log_info(paste0("category_id: ", toString(tv_data$category_id)))
logger::log_info(paste0("title: ", toString(tv_data$title)))
tv_data_c <- setNames(tv_data$category_id, tv_data$title)

# combo box
renderUI({
  selectInput("categories", "Categories:", tv_data_c, multiple=T)
})
```

```{r}
# And HERE, show legend, common for all plots. (show in alphabetical
# order) (HTML)

renderUI({
  colors = category_colors()
  
  if (any(is.na(colors))) {
    return(tags$div(style="color: red", "Please select a category."))
  }

  colors <- colors[order(names(colors))]
  tags$div(
    style = "margin: 10px;",
    lapply(names(colors), function(name) {
      # small colored square + label
      tags$div(
        style = paste0("display: flex; align-items: center; margin-bottom: 5px;"),
        tags$div(
          # force size
          style = paste0("width: 20px; height: 20px; flex: 0 0 20px; background-color: ", colors[name], "; margin-right: 10px; border-radius: 50%;"),
        ),
        tags$span(name)
      )
    })
  )
})
```

Row
-----------------------------------------------------------------------

### Views

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$views), color = "primary") })
```

### Clicks

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$clicks), color = "primary") })
```

### Comments

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$comments), color = "primary") })
```

### Follows

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$follows), color = "primary") })
```

### Collects

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$collects), color = "primary") })
```

### Forwards

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$forwards), color = "primary") })
```

### Hates

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$hates), color = "primary") })
```

### Likes

```{r results = "asis"}
renderValueBox({ valueBox(format(category_engagement()$likes), color = "primary") })
```

Row
-----------------------------------------------------------------------

### Gender distribution

```{r results = "asis"}
renderPlotly({
  plot <- category_data() %>%
    group_by(user_id, gender) %>%
    ggplot(aes(group=category_name, fill=category_name, x=gender)) +
    stat_count(aes(y = ..prop.., group = category_name, fill = category_name), position = "dodge") +
    labs(y=NULL, x=NULL) +
    scale_x_discrete(labels=c("M"="Male", "F"="Female")) +
    scale_color_manual(values = category_colors(), guide="none") +
    scale_fill_manual(values = category_colors(), guide="none") +
    theme_category()
  PLOTLY(plot)
})
```

### Views by Age

```{r results = "asis"}
renderPlotly({
  plot <- category_data() %>%
    ggplot(aes(group=category_name, color=category_name, fill=category_name, x=age)) +
    geom_density(aes(alpha=ALPHA)) +
    labs(y=NULL, x=NULL) +
    scale_color_manual(values = category_colors(), guide="none") +
    scale_fill_manual(values = category_colors(), guide="none") +
    theme_category()
  PLOTLY(plot)
})
```

### Views by Model Price

```{r results = "asis"}
renderPlotly({
  plot <- category_data() %>%
    ggplot(aes(group=category_name, color=category_name, fill=category_name, x=mod_price)) +
    geom_density(aes(alpha=ALPHA)) +
    labs(y=NULL, x="model price ($)") +
    scale_color_manual(values = category_colors(), guide="none") +
    scale_fill_manual(values = category_colors(), guide="none") +
    theme_category()
  PLOTLY(plot)
})
```

Row
-----------------------------------------------------------------------

### Video Durations

```{r results = "asis"}
renderPlotly({
  plot <- category_data() %>%
    group_by(title, category_name) %>%
    summarise(
      duration = mean(duration, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    ggplot(aes(group=category_name, color=category_name, fill=category_name, x=duration)) +
    geom_density(aes(alpha=ALPHA)) +
    labs(y=NULL, x="duration (seconds)") +
    scale_color_manual(values = category_colors(), guide="none") +
    scale_fill_manual(values = category_colors(), guide="none") +
    theme_category()
  PLOTLY(plot)
})
```

### Video Play Time (hour)

```{r results = "asis"}
renderPlotly({
  plot <- category_data() %>%
    ggplot(aes(x=p_hour)) +
    # histogram normalized by category_name
    stat_count(aes(y = ..prop.., group = category_name, fill = category_name), position = "dodge") +
    facet_grid(cols = vars(category_name), scales = "fixed") +
    labs(y=NULL, x="play hour") +
    scale_color_manual(values = category_colors(), guide="none") +
    scale_fill_manual(values = category_colors(), guide="none") +
    theme_category()
  PLOTLY(plot)
})
```

Engagement
==========

Column {data-width=400}
-----------------------------------------------------------------------

### Controls

```{r}
inputPanel(
  sliderInput("time_hour", 
              "Pick Hour (0-23):", 
              min = min(df$p_hour, na.rm = TRUE), 
              max = max(df$p_hour, na.rm = TRUE), 
              value = min(df$p_hour, na.rm = TRUE), 
              step = 1, round = TRUE, sep = "",
              animate = animationOptions(interval = 1200, loop = TRUE))
)
```

### City Tier Engagement (Selected Hour)

```{r}
renderPlotly({
  hour_data <- get_hourly_engagement(input$time_hour)
  
  p <- ggplot(hour_data, aes(x = reorder(plot_tier, total_engagement), 
                            y = total_engagement, 
                            fill = plot_tier)) +
    geom_col() +
    coord_flip() +
    labs(
      title = paste("Engagement by City Tier - Hour", input$time_hour),
      x = "City Tier",
      y = "Total Engagement"
    ) +
    theme_minimal() +
    theme(legend.position = "none") +
    scale_fill_viridis_d()
  
  ggplotly(p, tooltip = c("x", "y"))
})
```

Column {data-width=600}
-----------------------------------------------------------------------

### Engagement Over Time by City Tier

```{r}
renderPlotly({
  all_data <- get_all_hours_data()
  
  p <- ggplot(all_data, aes(x = p_hour, y = total_engagement, 
                           color = plot_tier, group = plot_tier)) +
    geom_line(size = 1.2) +
    geom_point(size = 2) +
    labs(
      title = "Engagement Throughout the Day",
      x = "Hour of Day (0-23)",
      y = "Total Engagement",
      color = "City Tier"
    ) +
    theme_minimal() +
    scale_color_viridis_d() +
    geom_vline(xintercept = input$time_hour, color = "red", linetype = "dashed", alpha = 0.7)
  
  ggplotly(p, tooltip = c("x", "y", "colour"))
})
```

### Heatmap Alternative

```{r}
renderPlotly({
  all_data <- get_all_hours_data()
  
  # Create a matrix for heatmap
  heatmap_data <- all_data %>%
    select(p_hour, plot_tier, total_engagement) %>%
    tidyr::pivot_wider(names_from = plot_tier, values_from = total_engagement, values_fill = 0)
  
  # Convert to matrix for heatmap
  mat <- as.matrix(heatmap_data[, -1])
  rownames(mat) <- heatmap_data$p_hour
  
  plot_ly(
    z = ~mat,
    x = ~colnames(mat),
    y = ~rownames(mat),
    type = "heatmap",
    colorscale = "YlOrRd",
    hovertemplate = "Hour: %{y}<br>City Tier: %{x}<br>Engagement: %{z}<extra></extra>"
  ) %>%
  layout(
    title = "Engagement Heatmap: Hour vs City Tier",
    xaxis = list(title = "City Tier"),
    yaxis = list(title = "Hour of Day")
  )
})
```
